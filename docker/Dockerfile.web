FROM node:20-alpine AS build
WORKDIR /app
COPY frontend/package.json frontend/package-lock.json* /app/frontend/
WORKDIR /app/frontend
RUN npm install
COPY frontend/ /app/frontend/
RUN npm run build

FROM nginx:alpine
COPY docker/nginx.conf /etc/nginx/conf.d/default.conf
# BuildKit/overlay edge cases can leave one stale trailing "}" in default.conf.
# Trim exactly one duplicated terminal brace if it appears after a blank line.
RUN awk '{ lines[NR]=$0 } END { \
  n=NR; \
  while (n>0 && lines[n]=="") n--; \
  prev=n-1; \
  while (prev>0 && lines[prev]=="") prev--; \
  if (n>0 && prev>0 && lines[n]=="}" && lines[prev]=="}") { lines[n]=""; n--; } \
  for (i=1; i<=n; i++) print lines[i]; \
}' /etc/nginx/conf.d/default.conf > /tmp/default.conf \
 && mv /tmp/default.conf /etc/nginx/conf.d/default.conf
COPY --from=build /app/app/static/dist /usr/share/nginx/html
EXPOSE 80
