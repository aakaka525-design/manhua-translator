# Cross-Page Context Design (Long Image Split)

Date: 2026-01-28
Project: manhua
Focus: 解决跨页字幕框语义不连贯（同一气泡被分页截断）

## 1. 背景
当前 pipeline 按“单页图片”独立 OCR/翻译/渲染。当字幕框被截断在两张相邻图片的边界时，
单页处理会导致语义割裂、重复翻译或漏译。

## 2. 目标
- 识别并合并跨页字幕框（同一气泡文本跨页拆分）。
- 保持现有单页处理流程为主，仅在边界处引入跨页上下文。
- 避免重复渲染或重复翻译。

## 3. 非目标
- 不改变既有切图逻辑或 OCR 模型。
- 不做全章全图拼接处理（成本过高）。
- 不引入重模型语义判定（仅轻量规则）。

## 4. 核心方案（推荐）
**跨页上下文带 + 全局坐标分组**

### 4.1 上下文带
对每一页，额外取：
- 上一页底部带（例如 64~128px）
- 下一页顶部带（例如 64~128px）

上下文带只用于 OCR + 分组，不参与最终渲染。

### 4.2 全局坐标
由于页面来自“同一长图切片”，给每一页引入 `page_offset_y`（该页在长图中的起始 y）。
对 OCR 结果增加 `global_box_2d`：
```
region.global_box_2d = box_2d + page_offset_y
```

### 4.3 跨页分组
对“本页 OCR + 上下文带 OCR”合并后进行分组，分组算法使用 `global_box_2d` 作为坐标空间。
只允许在 **页底带与下一页页顶带之间** 匹配跨页气泡，降低误合并概率。

## 5. 分组/去重规则
### 5.1 几何约束
跨页匹配需满足：
- 垂直间距小（global_y 连续）
- x 重叠率 >= 0.5
- 高度差 < 30%

### 5.2 文本轻量约束
- 若任一侧明显结束符号（句号/省略号），默认不跨页合并
- 双侧都很短（1~2 词）允许合并

### 5.3 去重
上下文带 OCR 与本页 OCR 重叠时：
- IOU > 0.7 或“严格包含” → 丢弃上下文带区域

## 6. 翻译与渲染分配
跨页合并后的 group 只翻译一次，但渲染需分配到正确页：
- 取 group 中 **面积最大、位于该页** 的区域作为“该页渲染主区域”
- 其它页区域使用 `[INPAINT_ONLY]` 仅擦除，不渲染
- 若 group 中心落在下页，上页只擦除不渲染（避免“半句”出现在上页）

## 7. 数据结构变更（最小化）
- RegionData 增加：
  - `global_box_2d: Optional[Box2D]`
  - `page_index: Optional[int]`
  - `page_offset_y: Optional[int]`

- TaskContext 增加（可选）：
  - `page_height: Optional[int]`（用于推导 offset）

## 8. 配置
- `config/ocr.yml` 中增加：
  - `edge_band_height: 64`
  - `edge_band_min_height: 48`
- `config/translator.yml` 中增加：
  - `cross_page_enabled: true`
  - `cross_page_x_overlap: 0.5`
  - `cross_page_y_gap_ratio: 0.8`

## 9. 测试计划
1) **跨页合并测试**：上下两页同一文本片段应合并成同一组。
2) **去重测试**：上下文带重叠区域不应重复进入分组。
3) **渲染分配测试**：跨页合并后仅在一页渲染文本，另一页 `[INPAINT_ONLY]`。

## 10. 风险与缓解
- **误合并**：限制匹配只在边界带、加强几何约束。
- **漏合并**：逐步放宽阈值并在失败样例中调参。
- **重复渲染**：通过 `[INPAINT_ONLY]` 保证单页仅渲染一次。

## 11. 里程碑建议
- Phase 1：加入上下文带 OCR + global 坐标 + 去重
- Phase 2：启用跨页分组 + 翻译分配
- Phase 3：调参与更多样本验证
