# SFX 识别与混合语言回退修复设计

日期：2026-02-01  
项目：manhua  
状态：设计已确认（混合策略）

## 背景
质量报告与复跑证据表明：多条韩文拟声词未被识别为 SFX，直接进入 AI 翻译导致错译；同时，混合语言结果只要含中文就被视为成功，出现英文残留。当前质量报告也缺少 `normalized_text/is_sfx` 等可回溯字段，定位成本较高。

## 目标
- 提高韩文 SFX 识别召回率，但控制误判（对白不被误标）。
- 修正混合语言残留（英文占比高时触发一次回退）。
- 保持流程稳定，不引入新模型或大规模重构。
- 允许在调试模式下输出 SFX 判定相关字段，便于回溯。

## 非目标
- 不引入 SFX 训练模型或外部词库服务。
- 不重做 OCR 或渲染流程。
- 不做全量重翻或高成本多轮重试。

## 方案概览
A) **SFX 识别：词库优先 + 低风险启发式**  
B) **混合语言回退：英文残留占比阈值触发**  
C) **调试可观测性：在 QUALITY_REPORT_DEBUG=1 时输出 is_sfx/normalized_text**

## 方案细节
### 1) SFX 识别（混合策略）
- **词库优先**：保留 `KO_SFX_MAP/EN_SFX_MAP` 作为最高置信来源。
- **新增词库项（明确纠错）**：
  - `부들` -> `颤抖`
  - `무들` -> `颤抖`
  - `헤이뉴트드`、`탈간잘자리` 先不硬编码译文，仅依靠 SFX 识别后走韩文音译（romanization），满足“音译或保留”的最低要求。
- **低风险启发式**（满足全部条件才判 SFX）：
  1. 去除末尾标点后，韩文长度 <= 4（默认），
  2. 韩文字母占比 >= 0.8，
  3. 不含空格，
  4. 允许末尾 `!/?/…` 等标点，
  5. 若匹配重复音节模式（如 `쿵쿵` / `근근근`），直接判定。
- **短对话排除表（可选）**：对常见韩文短语粒度词（如 `어/왜/네/나/너`）设置排除，减少误判。
- **落点**：
  - OCR 后置处理 `OCRPostProcessor._is_sfx` 增强；
  - 翻译阶段 `TranslatorModule._is_sfx` 保留兜底判断。

### 2) 混合语言残留回退
- 新增 `english_ratio` 计算（ASCII 字母占比 / 非空字符数）。
- 当目标语言为中文且 `english_ratio >= 0.35`，触发一次回退翻译（优先使用原文输入）。
- 保留现有“无中文则回退”的规则，形成双条件触发：
  - `not has_cjk` **或** `english_ratio >= threshold`。

### 3) 调试可观测性
- 在 `QUALITY_REPORT_DEBUG=1` 时，在 `regions[].debug` 中输出：
  - `normalized_text`
  - `is_sfx`
  - 可选 `sfx_rule`（dictionary / heuristic / repeat / excluded），用于定位误判原因。
- 默认关闭，不影响生产报告体积。

## 测试计划（最小集）
1) 词库优先：`부들/무들` 被识别为 SFX 且输出“颤抖”。
2) 启发式命中：短韩文（无空格）被识别为 SFX。
3) 误判防护：`유령씨표정이` 仍为非 SFX。
4) 混合语言回退：`O-OR THAT 那个大叔..??` 触发回退。

## 风险与缓解
- **误判对白为 SFX**：通过长度、韩文占比、无空格与排除表控制。
- **回退触发过多**：英文占比阈值保守设置，仅触发一次回退。

## 兼容性
默认行为基本一致，仅在 SFX 识别与混合语言回退条件上更严格；若关闭调试开关，质量报告结构不变。
